'use client';

import React from 'react';
import Card from '@/components/ui/Card/Card';
import Button from '@/components/ui/Button/Button';
import { IPurchase } from '@/schemas/PurchaseSchema';
import { Pencil } from 'lucide-react';
import { format } from 'date-fns';
import RowActions from '@/components/ui/RowActions/RowActions';
import { hasPermission } from '@/server/getUserSession';

interface PurchaseCardProps
{
    purchase: IPurchase;
    onEdit?: (purchase: IPurchase) => void;
    onView?: (purchase: IPurchase) => void;
    onDelete?: (purchase: IPurchase) => void;
    permissions: string[];
}

const PurchaseCard: React.FC<PurchaseCardProps> = ({ purchase, onEdit, onView, onDelete, permissions }) =>
{
    const { title, notes, amount, date, createdAt, updatedAt, createdByUser, updatedByUser } = purchase;

    // Format date nicely
    const formattedDate = date
        ? format(new Date(date), 'HH:mm dd-MM-yyyy')
        : createdAt ? format(createdAt?.toString(), 'HH:mm dd-MM-yyyy') : '';

    return (
        <Card className="overflow-hidden rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-all bg-white group" >
            {/* Header Section */}
            <div className="p-1 flex justify-between items-start">
                <div>
                    <h6 className="text-lg font-semibold text-gray-900 truncate">{title.length > 17 ? title.slice(0, 16) + "..." : title} </h6>
                    <p className="text-sm text-gray-500">{formattedDate}</p>
                </div>
                <RowActions
                    className='!gap-0'
                    onView={() =>
                    {
                        if (purchase)
                        {
                            onView?.(purchase)
                        }
                    }}
                    onEdit={() =>
                    {
                        if (purchase)
                        {
                            onEdit?.(purchase)
                        }
                    }}
                    onDelete={() =>
                    {
                        onDelete?.(purchase)
                    }}
                    showView={hasPermission(permissions, "purchase:view")}
                    showEdit={hasPermission(permissions, "purchase:update")}
                    showDelete={hasPermission(permissions, "purchase:delete")}
                />
            </div>

            {/* Content Section */}
            <div className="px-4 pb-4 space-y-3">
                {notes && (
                    <p className="text-sm text-gray-600 line-clamp-3 border-l-2 border-gray-300 pl-2 italic">
                        {notes.length > 35 ? notes.slice(0, 35) + '...' : notes}
                    </p>
                )}

                <div className="text-sm text-gray-700 space-y-2">
                    <div className="flex justify-between">
                        <span className="font-medium text-gray-600">Amount:</span>
                        <span className="text-green-600 font-semibold">Rs. {Number(amount).toFixed(2)}</span>
                    </div>

                    <div className="flex justify-between">
                        <span className="font-medium text-gray-600">Created By:</span>
                        <span>{createdByUser?.name ?? "-"}</span>
                    </div>

                    <div className="flex justify-between">
                        <span className="font-medium text-gray-600">Updated By:</span>
                        <span>{updatedByUser?.name ?? "-"}</span>
                    </div>

                    {updatedAt &&
                        <div className="flex justify-between">
                            <span className="font-medium text-gray-600">Last Updated:</span>
                            <span>{format(new Date(updatedAt), 'dd MMM yyyy, HH:mm')}</span>
                        </div>
                    }
                </div>
            </div>
        </Card>
    );
};

export default PurchaseCard;
